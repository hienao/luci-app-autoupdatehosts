<%+header%>

<div class="cbi-map">
    <h2><%:Auto Update Hosts Log%></h2>
    
    <div class="cbi-section">
        <div class="cbi-section-node">
            <div class="cbi-value">
                <div class="cbi-value-field">
                    <input type="button" id="log_control" class="cbi-button cbi-button-apply" value="<%:Start Refresh%>" onclick="toggleRefresh()" />
                    <input type="button" class="btn cbi-button cbi-button-remove" value="<%:Clear Log%>" onclick="clearLog()" />
                </div>
            </div>
            <div class="cbi-value">
                <div class="cbi-value-field">
                    <textarea id="log_content" class="log-textarea" readonly="readonly"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.log-textarea {
    width: 100%;
    height: 500px;
    padding: 10px;
    font-family: monospace;
    box-sizing: border-box;
    margin: 10px 0;
}
</style>

<script type="text/javascript">
var XHR = new XHR();
var refreshTimer = null;
var isRefreshing = false;

function toggleRefresh() {
    var btn = document.getElementById('log_control');
    isRefreshing = !isRefreshing;
    
    if (isRefreshing) {
        btn.value = '<%:Stop Refresh%>';
        refreshTimer = setInterval(fetchLog, 1000);
    } else {
        btn.value = '<%:Start Refresh%>';
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
    }
}

function clearLog() {
    XHR.post('<%=luci.dispatcher.build_url("admin", "services", "autoupdatehosts", "clear_log")%>', null,
        function(x, result) {
            if (x.status == 200) {
                document.getElementById('log_content').value = '';
            } else {
                alert('<%:Clear log failed%>: ' + x.status);
            }
        },
        function() {
            alert('<%:Clear log failed%>: <%:Network error%>');
        }
    );
}

function fetchLog() {
    XHR.get('<%=luci.dispatcher.build_url("admin", "services", "autoupdatehosts", "get_log")%>', null,
        function(x, data) {
            if (data && data.log) {
                var textarea = document.getElementById('log_content');
                textarea.value = data.log;
                textarea.scrollTop = textarea.scrollHeight;
            }
        }
    );
}

window.onload = function() {
    fetchLog();
};
</script>

<%+footer%> 